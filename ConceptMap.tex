% Flowchart
% Author: Stefan Kottwitz
% https://www.packtpub.com/hardware-and-creative/latex-cookbook
\documentclass[border=20pt]{standalone}
%\usepackage[a0paper,vmargin=3cm]{geometry}
\usepackage[a4paper,vmargin=3cm]{geometry}
%\usepackage{cooltooltips]
%\usepackage{hyperref}
%
%\usepackage{xcolor}
%
%\usepackage{pdfcomment}
% \usepackage{array}
\newcounter{rowno}
\setcounter{rowno}{0}


\usepackage{tikz}
\usetikzlibrary{matrix,calc,shapes,decorations.pathreplacing,calligraphy}
\tikzset{
  treenode/.style = {shape=rectangle, rounded corners,
	draw, anchor=center,
	text width=12em, align=center,
	top color=white, bottom color=blue!20,
	inner sep=1ex},
%  decision/.style = {treenode, diamond, inner sep=0pt},
  %concept/.style = {treenode, diamond, inner sep=0pt},
  concept/.style = {treenode, bottom color=cyan!30},
  blank/.style = {draw=none, bottom color=white!30, font=\ttfamily\large},
  background/.style      = {treenode, bottom color=red!30},
  %background/.style      = {treenode, bottom color=red!30, font=\ttfamily\small},
  section/.style      = {treenode, bottom color=green!30},
  activity/.style = {treenode, bottom color=yellow!30},
  skill/.style = {treenode, bottom color=blue!30},
  topic/.style = {treenode, bottom color=orange!30},
  part/.style = {treenode, bottom color=magenta!30},
  root/.style     = {treenode, font=\Large, bottom color=yellow!30},
%  env/.style      = {treenode, font=\ttfamily\normalsize},
  finish/.style   = {root, bottom color=green!40},
  dummy/.style    = {circle,draw}
}
\newcommand{\yes}{edge node [above] {yes}}
\newcommand{\no}{edge  node [left]  {no}}
\begin{document}

\begin{tikzpicture}[-latex]
  \matrix (chart)
    [
      matrix of nodes,
      %anchor=west,
      column sep      = 3em,
      row sep         = 5ex,
      column 1/.style = {nodes={section}},
      column 2/.style = {nodes={background}},
      column 3/.style = {nodes={activity}},
	    column 4/.style = {nodes={skill}},
      column 5/.style = {nodes={topic}},
	    column 6/.style = {nodes={concept}}
      % ,\stepcounter{rowno}
      % \stepcounter{rowno}\therowno \hspace{1cm}
%      column 7/.style = {nodes={concept}},
%	  column 8/.style = {nodes={section}},
%	  column 9/.style = {nodes={background}}
    ]
    {
      %& &  |[root]| Prosection               \\
      |[blank]|Section     & |[blank]|Background  & |[blank]|Activity/HOW-TO/ Milestone  & |[blank]|Skill &  |[blank]|Science/Engineering topic & |[blank]|Core concept  \\
%
       |[part]| \textbf{PART I: INTRODUCTION}   & &      & &        &      \\

      1. \textbf{Communicating w/ your microcontroller}   & & Meet your microcontroller     & &        &      \\
          1.1 Establishing communications    &  &    & &        &      \\
          1.2 Connecting via USB    & 1.2.1 Installing drivers for USB &    & &        &      \\
              & 1.2.2 USB connections via Chrome & Connect via BeagleTerm & Wired communication with microcontrollers &        &      \\
              & 1.2.3 USB connections via mpfshell &   Install mpfshell & &        &      \\
              &  &   Connect via mpfshell & &        &      \\
          1.3 Connecting via WiFi     & 1.3.1 WiFi access points \& stations &  Configure/connect to AP  &  &        &      \\
                                 &   &  Configure/connect in station mode  & &        &      \\
              & 1.3.2 WiFi connections via WebREPL &  Launch WebREPL  & Wireless communications with microcontrollers &        & Fundamentals of microcontroller function     \\
                                 &   &  Upload a file  & &        &      \\
                                 &   &  Download a file  & &        &      \\
              & 1.3.3 WiFi connections via mpfshell & Connect over WiFi w/ mpfshell  & &        &      \\
      1.4 Computing on your microcontroller    &  1.4.1 Generating random numbers and strings &  Generate random numbers and strings  & & Pseudo-random number generation         &      \\
              & 1.4.2 Encryption of character strings &  Encrypt/decrypt messages  & Python coding &        &  \\
              & 1.4.3 Encrypted authentication of data messages &  Verify a data message  & &  Data encoding (Hexadecimal system, refer to UART section?)    &  Data handling, security \& accessibility    \\

      2. \textbf{Circuit-building with MicroPython}   &  &    & &        &      \\
          2.1 Assembling circuits with breadboards    & 2.1.1 Breadboard basics &    & Breadboard circuit layout \& debugging &        &      \\
              & 2.1.2 Using GPIOs &    & &        &      \\
              &  GPIOs as outputs &  Turn on/off on-board LEDs  & GPIO interfaces &        &      \\
          2.2 Creating circuits on a  breadboard   & 2.2.1 Distributing power & Create power distribution sub-circuit   & &        &      \\
             & 2.2.2 GPIOs as inputs & Assemble button switch sub-circuit   & Breadboard circuit layout \& debugging &        &  Circuit design, analysis \& testing   \\
             & 2.2.3 GPIO interrupts and handlers & Program an interrupt   & GPIO interfaces, Python coding (functions) &  Microcontroller responses to environmental signals      &      \\
             & 2.2.4 Controlling external devices & Power an external LED   & &        &      \\
             &  & Switch an LED with a relay   &  &  Actuation \& switching of external devices      &      \\
             &  & Control an electric fan motor   &  &        &      \\
             & 2.2.5 Fine control with Pulse Width Modulation & Snooze an LED   & Power modulation \& device control &        & Sensor range, resolution \& saturation (human vision) \\
             &       & Control a servo motor   & &        &  \\

      3. \textbf{Keeping track of time}   &  &    & &        &      \\
          3.1 Accuracy and precision    &  &    & &        &      \\
          3.2 Setting/reading time on the ESP8266    & 3.2.1 On-board RTC & Read/set on-board RTC   & Measuring time &        &      \\
              & 3.2.2 Network Time Protocol  & Obtain time from NTP   & Internet communications &  Signal propagation latency  & Calibration \& ground truthing     \\
              & 3.2.3 DS3231 (external) RTC & Set up an external RTC   & I2C digital devices (preview) &       &      \\
      3.3 Accuracy \& precision of time-keeping on the ESP8266    & 3.3.1 Generating a dataset of time-keeping errors & Generate a time-keeping dataset   & Python coding (File I/O, data logging) &          \\
              & 3.3.2 Visualizing distributions of errors  & Plot time-keeping errors   & Python coding (plotting) &        & Data visualization     \\
              & 3.3.3 Hypothesis tests about RTC accuracy \& precision  & Probability plots \& hypothesis tests w/ RTC data   & Python coding (statistical tests) &   & Hypothesis generation \& testing \\
              & 3.3.4 Environmental effects on RTC accuracy \& precision \& precision  & Quantifying temperature effects on time-keeping errors   & & Temperature effects on sensors  &      \\
%
%
       |[part]| \textbf{PART II: FUNDAMENTALS OF ENVIRONMENTAL SENSING}   & &      & &        &      \\

      4. \textbf{Environmental sensing w/ voltage, current and resistance}   &  &    & &        &      \\
          4.1 Measuring voltage    & 4.1.1 Voltage of an 18650 battery &    & &        &      \\
              & Ohm's Law for voltage, current and resistance &    & & Voltage, current \& resistance/ Ohm's Law   &   Sensor range, resolution \& saturation (ADC voltage limits \& resolution)   \\
              & Designing a voltage divider using Ohm's Law & Design a voltage divider circuit   & Ohm's Law calculations  &        & Circuit design, analysis \& testing     \\
              &  & Assemble/test a voltage divider circuit   & Breadboard circuit layout \& debugging &        &   \\
          4.2 Environmental sensing w/ voltage: measure voltage w/ a thermistor    & 4.2.1 Thermistor temperature resistance curves & Calibrate a thermistor   & &   Temperature effects on sensors     &      \\
              & 4.2.2 Thermistor circuit design & Design a voltage divider for a thermistor   & GPIO interfaces (ADC) &  Data encoding  &  Calibration \& ground truthing    \\
              & 4.2.3 Thermistor circuit assembly \& programming & Build \& test a thermistor circuit   & &        &      \\
          4.3 Environmental sensing w/ time: measuring light intensity with frequency    & 4.3.1 Measuring light with frequency & Assemble \& test a frequency-based light sensor circuit   & Breadboard circuit layout \& debugging &        &      \\
              & 4.3.2 Dividing frequency to increase sensor range & Measure divided frequency from a light sensor   & GPIO interfaces & Microcontroller responses to environmental signals       &      Sensor range, resolution \& saturation ($\mu s$ measurement limits)\\
              & 4.3.3 Optimizing a light sensor driver & Optimize a light sensor driver   & Python coding (drivers) &        &      \\
          4.4 Environmental sensing with time: Calibrate an acoustic distance sensor   &  &      \\

      5. \textbf{Digital interfaces for environmental sensors}   & 5.0.1 Communicating with digital sensors &    & &        &      \\
          5.1 I2C sensors   & 5.1.1 Background &      \\
             & 5.1.2 Measuring temperature with a high-resolution sensor   &  &        &    \\
             & 5.1.5 Using I2C over long cables with differential extenders   &  &        &    \\
          5.2 1-wire sensors   &  5.2.1 Background &      \\
             & 5.2.2 Temperature measurements with DS18B20 digital sensors &  Sample temperatures from multiple ``cabled'' sensors   &  &        &    \\
             & 5.2.4 Accuracy \& precision of DS18B20 temperature sensors & Quantifying errors with a high-resolution temperature sensor   &   &        &    \\
             &  & Recalibration of DS18B20 temperature sensors   &   &        &    \\
             & 5.2.5 Monitoring temperature changes across time & Logging temperature time series   &   &        &    \\

          5.3 UART sensors   &  5.3.1 Background &   & Hexadecimal system   \\
             & 5.3.2 Measuring position \& velocity using the Global Positioning System (GPS) &  Track a route using a GPS receiver  &  &        &    \\
             & 5.3.3 Measuring atmospheric particle pollution &  Sample Air Quality Index   &  &        &    \\
             & 5.3.4 Tracking ships using Automatic Identification System (AIS) &  Track vessels using an AIS receiver  &  &        &    \\
          5.4 SPI sensors   &  5.4.1 Background (SD card interfaces)&      \\
             & 5.4.2 SPI control of TFT display panels &    &  &        &    \\

      6. \textbf{Data telemetry and protocols for sensor communications}   &  &    & &        &      \\
          6.1 Message Queuing Telemetry Transport (MQTT)    & 6.1.1 Publishing \& subscribing to MQTT messages &    & &        &      \\
             & 6.1.2 Telemetry of sampling requests \& data &  Internet communications   &  &  Data encoding      &   Data handling, security \& accessibility   \\
             & 6.1.3 Logging, archiving \& disseminating MQTT data  & File I/O, data logging    & &        &  Data visualization    \\
          6.2 Microcontroller-based web servers   & 6.2.1 Web server setup \& testing &    & &        &      \\
             & 6.2.2 Data acquisition & dissemination via a web server &  Internet communications   & Data encoding &   Data handling, security \& accessibility   \\
%
%
       |[part]| \textbf{PART III: WORKING WITH ENVIRONMENTAL SENSORS}   & &      & &        &      \\

      7. \textbf{Measuring heat and energy flow}   & 7.1 Background: Conservation \& diffusion (conduction) of heat  &    & &        &      \\
          7.2 Evaporative cooling & 7.2.1 Inferring atmospheric conditions using temperature & Calculate humidity from wet- and dry-bulb temperatures   &  &        &    \\
          7.3 Heat transfer by conduction & 7.3.1 Measuring heat transfer by conduction   &  Temperature transients \& heat flow in a metal bar &        &    \\
                 &  & Interpolate \& plot temperature time series using Pandas  &   &        &    \\
                 &  & Animated data visualizations  &   &        &    \\
          7.4 Heating and cooling of lakes \& oceans & 7.4.1 Laboratory models of lakes \& oceans & Monitor temperature in a laboratory column during heating \& cooling   &  &        &    \\
                 & & 7.4.2 Heat transport in salinity-stratified water columns   &  &        &    \\
                 & & 7.4.3 Heat transport by turbuent mixing   &  &        &    \\
          7.5 Thermoelectric (Peltier) heating \& cooliing & 7.5.1 Temperature control using a Peltier device & Assemble and code a digital thermostat  & Power modulation \& control & & Feedback \& control   \\

      8.  \textbf{Quantifying light \& color}   &  &    & &        &      \\
          8.1 Dispersion of collimated \& diffuse light beams  & 8.1.1 Energy conservation \& the $r^2$ law &    &    &    \\
          8.2 Light attentuation through the water column & 8.2.1 Color-dependence of light absorption  & Digital devices (I2C) &        &    \\
                 &  8.2.2  Light scattering by suspended particles & Construct a turbidity sensor   &  &        &    \\
                 &  8.2.3 Light scattering by atmospheric pollution particles & Use scattering to measure Air Quality Index   &  &        &    \\
          8.3 Construction, calibration and use of a colorimetric pH sensor   &       \\

      9.  \textbf{Environmental effects on electrical characteristics}   &  &    & &        &      \\
          9.1 Capacitance  & 9.1.1  Make a proximity/touch sensor &    &    &    \\
            & 9.1.2  Use a capacitance touchpad as a Human Interface Devices  &    &    &    \\
            & 9.1.3  Measuring water levels with capacitance  &    &    &    \\
          9.2 Conductivity as an indicator of salinity  & 9.2.1  Measuring conductivity & Make a conductivity sensor     &    &    \\
          9.3 Photoresistors \& photodiodes  & 9.3.1  & & & & \\
          9.4  Pyroelectric motion detectors  & &    &    &    \\
%
%
       |[part]| \textbf{PART IV: PRACTICAL SKILLS IN ENVIRONMENTAL SENSING}   & &      & &        &      \\

      10.  \textbf{Computer Aided Design (CAD) \& fabrication} & & & & & \\

      11.  \textbf{Design of Printed Circuit Boards (PCBs)} & & & & & \\

      12.  \textbf{Power supply \& regulation for environmental instruments} & 12.1 Power usage measurement \& calculation & & & & \\
          12.2 Battery power for environmental instruments
          12.3 Low-cost solar power systems

      13.  \textbf{Water- \& weather-proofing \& environmental instruments} & & & & & \\
%
%
       |[part]| \textbf{PART V: QUANTIFYING ENVIRONMENTAL PROCESSES}   & &      & &        &      \\

      14. \textbf{Best practices for data management \& dissemination}   & 13.1 Deployment metadata  &    & &        &      \\
          14.1 Deployment metadata  &    & &        &      \\
          14.2 Data archiving \& database management

      15. \textbf{Monitoring flow of air \& water}   &  &    & &        &      \\
          15.1 Sensing magnetism with Hall effect sensors & Measuring pipe flow   & Measure flow with a yf-s201c flow meter &      \\
                     & Measuring wind speed and direction   & Build and calibrate an anemometer &      \\
                     & Measuring velocity of water currents   & Build and calibrate a taffrail log &      \\

      16.  \textbf{Tracking position, displacement, velocity \& orientation} & & & & & \\
};
% % Simple brace
% \draw [-,decorate,
%     decoration = {brace,mirror}] (chart-1-4)[left=] --  (chart-5-4)[midway,left];
%     % decoration = {brace,mirror}] (chart-1-4) --  (chart-5-4)[midway,left];
%
% % Calligraphic brace
% \draw [-,ultra thick,,decorate,
%     decoration = {calligraphic brace,mirror}] (0.2,1) --  (1.2,1);
% %      aligned at relation sign?  & align, flalign \\
% %      aligned at several places? & alignat        \\
% %      first left, centered,
% %        last right?              & multline       \\
% %      & & |[concept]| replicate \\
% %      & & |[treenode]| Add a \texttt{*} & |[finish]| Hypoth. Test \\
% %      & &  \\
% %    };
%   \draw[-]
% %    (chart-1-3) edge node [above] {data} (chart-2-1);
%     (chart-1-3) edge (chart-2-1)
%     (chart-1-3) edge (chart-2-3);
\end{tikzpicture}
\end{document}

  \draw
%    (chart-1-3) edge node [above] {data} (chart-2-1);
    (chart-1-3) edge (chart-2-1)
    (chart-1-3) edge (chart-2-3)
    (chart-1-3) edge (chart-2-5)
    (chart-2-1) edge (chart-3-1)
    (chart-2-3) edge (chart-3-3)
    (chart-2-5) edge (chart-3-5)
    (chart-4-1) edge node [above] {\hspace{1in} uncompress log section} (chart-5-2)
    (chart-4-3) edge node [above] {\hspace{2in} construct full frame from ROIs} (chart-5-4)
    (chart-3-1) edge (chart-4-1)
    (chart-3-3) edge (chart-4-3)
    (chart-3-5) edge (chart-4-5)
    (chart-5-2) edge (chart-6-1)
    (chart-5-4) edge (chart-6-3)
    (chart-6-1) edge node [above] {\hspace{1.5in} parse aqdp data from log section} (chart-7-2)
    (chart-6-3) edge (chart-7-4)
    (chart-7-2) edge node [below] {\hspace{1.25in} record data start/stop times} (chart-8-1)
    (chart-7-4) edge (chart-8-3)
    (chart-9-2) edge node [below] {\hspace{2in} record prosection start/stop times} (chart-10-1)
    (chart-8-1) edge node [above] {\hspace{2in} detect min/max depth in aqdp data} (chart-9-2)
    (chart-4-5) edge node [right] {\hspace{0in} detect min/max depth in CTD data} (chart-9-4)
    (chart-10-1) edge node [above] {\hspace{1.25in} extract data timestamp} (chart-11-2)
    (chart-9-4) edge node [above] {\hspace{2.25in} create section with timestamp in name} (chart-10-5)
    (chart-10-5) edge (chart-11-4)
    (chart-11-2) edge node [above] {\hspace{2.5in} find photo dir matching timestamp} (chart-12-3)
    (chart-11-4) edge node [above] {\hspace{2.25in} create list of matched aqdp/CTD data} (chart-12-5)


    ;
%    (chart-4-2) edge (chart-4-1);
%    (chart-1-2) edge (chart-2-7)
%    \foreach \x/\y in {2/3, 3/4, 4/5, 5/6} {
%      (chart-\x-1) \no (chart-\y-1) }
%    %\foreach \x in {2,...,6} {
%    \foreach \x in {3,...,6} {
%    	   (chart-\x-1) \yes (chart-\x-2) }
%   (chart-7-3) \no  (chart-8-3)
%   (chart-8-3) edge (chart-8-4);
 \draw
   (chart-8-3) -- +(0,-5) |- (chart-11-2)
   (chart-10-1) -- +(13,0) |- (chart-11-4);
%     node[near start,sloped,above] {no, reconsider};
%  \foreach \x in {3,...,6} {
%   \draw (chart-\x-2) -| (chart-7-3);}
% \draw   (chart-7-3)  -| (chart-8-4)
%   node[near start,above] {yes};
\end{tikzpicture}
\end{document}
